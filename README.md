# SRM 校内赛重构版框架 #

> 注：该框架为本人自用的重构魔改版，原版地址：  
> https://github.com/superwyq/robomaster_S1framework  
> 此项目为对原版的完全重构，不保证稳定性，随缘修 BUG

## 〇、更新记录 ##

- `2021.9.23` 修复 BUG，优化性能
- `2021.9.20` 重构完成
- `2021.9.16` 魔改版本完成

## 一、框架说明 ##

此部分内容和原版一致。
> 本框架为校内赛视觉部分使用框架，基于 Robomaster S1 步兵，使用 Python 编写。

## 二、环境依赖 ##

魔改版框架和原版框架所需依赖没有任何区别，具体依赖如下：
> pillow==8.3.2  
> numpy==1.21.2  
> opencv-python==4.4.0.42  
> pygame==2.0.1  
> robomaster==0.1.1.63

在 requirements.txt 中列出了相同内容。

## 三、使用说明 ##

### 目录结构 ###

本项目对原版进行了完全重构，目录结构如下：

```
SRM_S1_NEW
├───assets   # 资源文件
│   ├───*.ttf       # 字体
│   ├───*.jpg       # 图片
│   └───*.avi       # 视频
├───app      # 主代码
│   ├───core        # 核心框架
│   │   ├───msg.py         # 消息基类
│   │   ├───container.py   # 容器类
│   │   ├───vision.py      # 图像处理函数
│   │   └───controller.py  # 控制器基类
│   ├───controller  # 控制器
│   │   ├───proc.py        # 控制器进程
│   │   ├───main.py        # 功能实现
│   │   └───msg.py         # 消息封装
│   ├───benchmark   # 性能测试
│   │   ├───timer.py       # 简易计时器
│   │   └───cpu_usage.py   # 详细计时器
│   ├───ui          # 界面
│   │   ├───proc.py        # 界面进程
│   │   ├───main.py        # 功能实现
│   │   └───msg.py         # 消息封装
│   └───constants.py  # 常量定义
├───logs     # 日志
├───tmp      # 临时输出
└───main.py  # 程序入口
```

### 运行 ###

主程序通过终端开启：`python main.py`

> 参数:
> - `-d, --debug` 调试模式
> - `-r, --red` 选择红方
> - `-b, --blue` 选择蓝方
> - `--record` 录制视频

### 键位与操作 ###

通过 `WASD` 操作移动；  
按下 `Q` 开启自动瞄准、改变瞄准模式;  
按下 `E` 关闭自动瞄准；  
按下 `鼠标左键` 或 `鼠标右键` 开火；  
按下 `Esc` 退出。

### 自瞄平滑处理 ###

此框架带有自动瞄准代码，且原始自瞄数据带有大幅抖动，故此框架提供了两种平滑处理模式，分别为：

- 差分反馈（默认）：  
  前两个识别结果参与运算，并与当前结果构成三角形，根据三角形最大边长的不同划分：
    - 最大边长非常小：此时认为整个三角形都是识别结果抖动造成的，故对前两个结果附加较大的权值
    - 最大边长适中：此时认为前两个识别结果有一部分为抖动引起，故对前两个结果附加较小的权值
    - 最大边长较大：此时认为目标开始快速移动，对当前识别结果附加非常大的权值而几乎忽略前两个结果

  此模式的行为受以下常数控制：
    - `TRIANGULAR_DIFFERENCE_WEIGHT`：各个划分对应的权值，其默认值为 `((1, 3, 2), (2, 2, 1), (3, 1, 0))`
    - `TRIANGULAR_SIDE_LEN_LEVEL`：各个划分的分界线，其默认值为 `(24, 56)`，


- Kalman 滤波（备用）：  
  所有历史结果参与运算，用以预测当前结果，其行为受以下常数影响：
    - `KALMAN_SHAKE_CONTROL`：其默认值为 `1e-3`，此值越小，抖动越大，延迟越小
    - `KALMAN_DELAY_CONTROL`：其默认值为 `1e-1`，此值越小，抖动越小，延迟越大

### 性能测试 ###

- 要测试某个函数的耗时，导入模块:  
  `from app.benchmark.timer import *`  
  在函数定义前一行插入修饰器 `@timing` ，运行后可在对应的日志中查看
- 要测试某个函数内部各个行为的耗时，导入模块:  
  `from app.benchmark.cpu_usage import *`  
  在函数定义前一行插入修饰器 `@cpu_usage` ， 运行时将在控制台中显示
