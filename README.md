# SRM 校内赛 S1 框架 #

> 注：该框架为此项目的重构版：  
> https://github.com/superwyq/robomaster_S1framework

## 更新记录 ##

### VER 1.3.1 BETA: `2021.10.30` ###

- 修复：解决了直接套用模板后开启自动瞄准时报 `AssertionError` 错误的问题；
- 优化：使用未经修改的模板时自动瞄准将提供位于屏幕中心的目标。

### VER 1.3.0 BETA: `2021.10.30` ###

- 修复：修正了网络卡顿后枪管热量不减的问题；
- 新增：在屏幕正上方显示运行时间；
- 调整：按照规则更正了参数和扣血机制；
- 调整：（实验性）提高了控制器的速度同步频率，按住移动的持续时间从一秒变为无限长；
- 移除：（1.2.0）在界面上显示半透明的背景矩形，增加重要信息的辨识度。

### VER 1.2.0: `2021.10.30` ###

- 修复：解决了队列为满时界面和控制模块速度无法同步的问题；
- 修复：解决了在运行参数中多选颜色不会报错的问题；
- 优化：缩短了按下 `ESC` 后等待退出的时间；
- ~~新增：在界面上显示半透明的背景矩形，增加重要信息的辨识度；~~
- 新增：在界面上显示 FPS 的区域右边增加了对数据流传输延迟的显示；
- 调整：修改了默认的控制灵敏度。

### VER 1.1.0: `2021.10.28` ###

- 新增：自瞄模式下按右键可开关云台跟随（默认关闭），用于缓解延迟带来的抖动；
- 优化：在自瞄测试模块 `/app/test/vision` 及其模板的每一次循环开始处增加了复制当前帧图像代码，用于单帧调试；
- 修正：更改了 UI 中绿色和黄色 `F` 标记的提示判定规则为自瞄目标与屏幕中心点的距离。

### VER 1.0.0: `2021.10.26` ###

- 首个正式版。

## 注意事项 ##

1. （非常重要）DEBUG 模式和实机调试时所需要的控制器帧率并不相同，实机测试时调低此参数可导致图像传输卡顿；
2. 由于控制进程和界面进程先后启动，程序开始运行时会短暂延迟，调整控制器和界面帧率可缓解；
3. 使用自带自动瞄准时，由于 KALMAN 滤波器的特性，切换至 KALMAN 滤波器后目标位置会短暂漂移。

## 框架说明 ##

本框架为校内赛视觉部分使用框架，基于 RoboMaster S1 步兵，使用 Python 编写。

## 运行环境 ##

### 系统环境 ###

请尽可能在 __Windows__ + __Anaconda__ 环境中使用此框架，并且建议为此框架单独建立 Conda 环境以保持运行环境整洁：

```shell
$ conda create -n <NAME> python=3.8
```

其中 `<NAME>` 为环境名称。

> 此程序未在其他操作系统和环境中测试，不保证程序在这些环境中的稳定性和运行效果。

### Python 环境 ###

程序依赖的 Python 包列表如下：
> numpy==1.21.2  
> opencv-python==4.4.0.42  
> pygame==2.0.1  
> robomaster==0.1.1.63

在 Conda 环境中，请使用 `pip` 而非 `conda` 安装这些软件包：

```shell
$ conda activate <NAME>
$ cd <ROOT>
$ pip install -r ./requirements.txt
```

其中 `<NAME>` 为环境名称，`<ROOT>` 为框架主目录。

## 使用说明 ##

### 目录结构 ###

本项目的目录结构如下：

```
SRM_S1_NEW
├───assets     # 资源文件
│   ├───*.ttf  # 字体
│   ├───*.jpg  # 图片
│   └───*.avi  # 视频
├───app        # 主代码
│   ├───core          # 核心框架
│   │   ├───msg.py         # 消息基类
│   │   ├───container.py   # 容器类
│   │   ├───vision.py      # 图像处理函数
│   │   └───controller.py  # 控制器基类
│   ├───controller    # 控制器
│   │   ├───const          # 机器人参数
│   │   │   └───S1Robot         # RoboMaster S1
│   │   ├───proc.py        # 控制器进程
│   │   ├───main.py        # 功能实现
│   │   └───msg.py         # 消息封装
│   ├───benchmark     # 性能测试
│   │   ├───timer.py       # 简易计时器
│   │   └───cpu_usage.py   # 详细计时器
│   ├───test          # 功能测试
│   │   └───vision.py      # 视觉测试模块
│   ├───ui            # 界面
│   │   ├───proc.py        # 界面进程
│   │   ├───main.py        # 功能实现
│   │   └───msg.py         # 消息封装
│   ├───template      # 二次开发模板
│   │   └───...            # 此处内容请参考 README
│   └───config.py     # 设置
├───logs     # 日志
├───test.py  # 测试入口
└───main.py  # 程序入口
```

### 运行 ###

主程序通过终端开启：`python main.py`。

> 参数（不加参数无法运行）：
> - `-d, --debug` 调试模式；
> - `-r, --red` 选择红方；
> - `-b, --blue` 选择蓝方；
> - `--record` 开启录制。

### 键位与操作 ###

通过 `WSAD` 操作移动；  
按下 `Q` 开启自动瞄准、改变平滑模式；  
按下 `E` 关闭自动瞄准；  
按下 `鼠标左键` 开火；  
使用自动瞄准时，按下 `R` 重设滤波器和 ROI 以消除干扰，按下 `鼠标右键` 使自瞄结果作用于云台；  
使用手动瞄准时，按下 `I` 切换准星样式（十字线和圆圈）；  
按下 `Esc` 退出。

### 自定义配置项 ###

所有常数配置均在文件 `/app/config.py` 中，内附中文注释，可自行查看并修改。

### 自瞄平滑处理 ###

此框架带有自动瞄准代码，且原始自瞄数据带有大幅抖动，故此框架提供了两种平滑处理模式，分别为：

- 差分反馈（默认）：  
  前两个识别结果参与运算，并与当前结果构成三角形，根据三角形最大边长的不同划分：
    - 最大边长非常小：此时认为整个三角形都是识别结果抖动造成的，故对前两个结果附加较大的权值；
    - 最大边长适中：此时认为前两个识别结果有一部分为抖动引起，故对前两个结果附加较小的权值；
    - 最大边长较大：此时认为目标开始快速移动，对当前识别结果附加非常大的权值而几乎忽略前两个结果。

  此模式的行为受以下常数控制：
    - `TRIANGULAR_DIFFERENCE_WEIGHT`：各个划分对应的权值，其默认值为 `((1, 2, 1), (2, 2, 1), (3, 1, 0))`；
    - `TRIANGULAR_SIDE_LEN_LEVEL`：各个划分的分界线，其默认值为 `(24, 48)`。


- Kalman 滤波（备用）：  
  所有历史结果参与运算，用以预测当前结果，其行为受以下常数影响：
    - `KALMAN_SHAKE_CONTROL`：其默认值为 `1e-3`，此值越小，抖动越大，延迟越小；
    - `KALMAN_DELAY_CONTROL`：其默认值为 `1e-1`，此值越小，抖动越小，延迟越大。

## 开发指南 ##

去除了自带自动瞄准代码的模板文件全部位于 `/app/template` 中，目录结构与 `/app` 完全相同，请根据其中代码内的 `TODO` 注释自行编写代码。

### 功能测试 ###

#### 自动瞄准 ####

框架自带使用 OpenCV 监控自瞄状态的测试例程，输入 `python test.py --vision --[color]` 运行测试，按 `Q` 键退出。

#### 自定义测试 ####

若要添加测试模块，为保持代码可维护性，请仿照 `test.py` 中的 `TODO` 内容自行添加并编写。

### 性能统计 ###

- 要测试某个函数的耗时，导入模块:  
  `from app.benchmark.timer import *`  
  在函数定义前一行插入修饰器 `@timer` ，运行后可在对应的日志中查看。
- 要测试某个函数内部各个行为的耗时，导入模块:  
  `from app.benchmark.cpu_usage import *`  
  在函数定义前一行插入修饰器 `@cpu_usage` ， 运行时将在控制台中显示。

## 早期版本更新记录 ##

### Beta: `2021.10.2` ~ `2021.10.25` ###

- `2021.10.17` 添加测试模块；
- `2021.10.16` 重构；添加了自定义模板；
- `2021.10.9` 修复了一个严重 BUG；界面优化；
- `2021.10.6` 修改了视频录制方法；
- `2021.10.5` 添加分别限制显示、控制进程帧率的参数；
- `2021.10.4` 添加动态准星；
- `2021.10.2` 增强了 FPS 显示功能。

### Alpha: `2021.9.16` ~ `2021.10.1` ###

- `2021.9.29` 修复因延迟而跳过冷却时间点；
- `2021.9.28` 底盘旋转测试；
- `2021.9.27` 修复大量隐藏 BUG；
- `2021.9.26` 平滑过滤器改为按需运行；
- `2021.9.25` 整合参数至 `/app/constants.py` 集中控制；
- `2021.9.23` 优化手动瞄准性能；
- `2021.9.20` 重构完成；
- `2021.9.16` 魔改版本完成。
